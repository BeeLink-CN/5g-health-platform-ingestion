version: '3.8'

services:
  ingestion:
    build: .
    container_name: 5g-ingestion-service
    restart: unless-stopped
    ports:
      - "8091:8091"
    environment:
      - MQTT_URL=mqtt://mosquitto:1883
      - NATS_URL=nats://nats:4222
      - DATABASE_URL=postgresql://platform_user:platform_secret@timescaledb:5432/5g_health_platform
      - SERVICE_PORT=8091
      - NODE_ENV=production
      - LOG_LEVEL=info
      - CONTRACTS_PATH=/app/contracts/schemas
    volumes:
      - ./contracts:/app/contracts:ro
    depends_on:
      - timescaledb
      - nats
      - mosquitto
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8091/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Option 1: Connect to external network from infra repo
    networks:
      - 5g-platform-network
    # Option 2: Use bridge network for standalone mode
    # networks:
    #   - default

    # If using external network from infra repo
networks:
  5g-platform-network:
    external: true

# Uncomment for standalone mode (without infra repo)
# services:
#   timescaledb:
#     image: timescale/timescaledb:latest-pg15
#     container_name: timescaledb
#     environment:
#       - POSTGRES_USER=platform_user
#       - POSTGRES_PASSWORD=platform_secret
#       - POSTGRES_DB=5g_health_platform
#     ports:
#       - "5432:5432"
#     volumes:
#       - timescale-data:/var/lib/postgresql/data
#       - ./db/migrations:/docker-entrypoint-initdb.d:ro
#
#   nats:
#     image: nats:latest
#     container_name: nats
#     command: "-js -sd /data"
#     ports:
#       - "4222:4222"
#       - "8222:8222"
#     volumes:
#       - nats-data:/data
#
#   mosquitto:
#     image: eclipse-mosquitto:2
#     container_name: mosquitto
#     ports:
#       - "1883:1883"
#       - "9001:9001"
#     volumes:
#       - mosquitto-data:/mosquitto/data
#       - mosquitto-logs:/mosquitto/log
#
# volumes:
#   timescale-data:
#   nats-data:
#   mosquitto-data:
#   mosquitto-logs:
